package appleclient.config;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.Iterator;
import java.util.Map.Entry;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;

import appleclient.Apple;
import appleclient.mods.Mod;
import appleclient.mods.settings.ColorSetting;
import appleclient.mods.settings.Setting;
import appleclient.mods.settings.SliderSetting;
import appleclient.mods.settings.ToggleSetting;

public class AppleConfig
{
    private Gson gson = new Gson(), prettyGson = new GsonBuilder().setPrettyPrinting().create();
    private File config = new File("optionsapple.txt");
    private JsonParser jsonParser = new JsonParser();
    
    public void saveMods()
    {
        new Thread(() ->
        {
            JsonObject jsonObject = new JsonObject();
            
            for (Mod mod : Apple.CLIENT.modsManager.mods)
            {
                JsonObject jsonMod = new JsonObject();
                jsonMod.addProperty("Enabled", mod.isEnabled());
                jsonObject.add(mod.name, jsonMod);
                
                for (Setting setting : mod.settings)
                {
                    if (setting instanceof ToggleSetting)
                    {
                        ToggleSetting toggleSetting = (ToggleSetting) setting;
                        jsonMod.addProperty(setting.name, toggleSetting.enabled);
                    }

                    else if (setting instanceof SliderSetting)
                    {
                        SliderSetting sliderSetting = (SliderSetting) setting;
                        jsonMod.addProperty(setting.name, sliderSetting.currentValue);
                    }
                    
                    else if (setting instanceof ColorSetting)
                    {
                        ColorSetting colorSetting = (ColorSetting) setting;
                        jsonMod.addProperty(setting.name, new int[] {colorSetting.red, colorSetting.green, colorSetting.blue, colorSetting.alpha});
                    }
                }
            }
            
            try (PrintWriter printWriter = new PrintWriter(new FileWriter(config)))
            {
                printWriter.println(prettyGson.toJson(jsonObject));
            }
            
            catch (IOException e)
            {
            }
        }).start();
    }

    public void loadMods()
    {
        try (BufferedReader bufferedReader = new BufferedReader(new FileReader(config)))
        {
            JsonObject jsonObject = (JsonObject) jsonParser.parse(bufferedReader);
            Iterator iterator = jsonObject.entrySet().iterator();
            
            while (iterator.hasNext())
            {
                Entry entry = (Entry) iterator.next();
                String modName = (String) entry.getKey();
                Mod mod = Apple.CLIENT.modsManager.getMod(modName);
                JsonObject jsonMod = (JsonObject) entry.getValue();
                
                if (jsonMod.get("Enabled").getAsBoolean())
                {
                    mod.setEnabled(true);
                }
                
                else if (mod.isEnabled())
                {
                    mod.setEnabled(false);
                }
                
                for (Setting setting : mod.settings)
                {
                    if (setting instanceof ToggleSetting)
                    {
                        ToggleSetting toggleSetting = (ToggleSetting) setting;
                        toggleSetting.enabled = jsonMod.get(setting.name).getAsBoolean();
                    }

                    else if (setting instanceof SliderSetting)
                    {
                        SliderSetting sliderSetting = (SliderSetting) setting;
                        jsonMod.addProperty(setting.name, sliderSetting.currentValue);
                    }
                    
                    else if (setting instanceof ColorSetting)
                    {
                        ColorSetting colorSetting = (ColorSetting) setting;
                        jsonMod.addProperty(setting.name, colorSetting.red + ";" + colorSetting.green + ";" + colorSetting.blue + ";" + colorSetting.alpha);
                    }
                    
                    if (setting.getTypeOfSetting().equals("Check Box")) {
                        setting.setIndex((float) (jsonMod.get(setting.getName()).getAsBoolean() ? 1 : 0));
                        setting.setCheckBoxValue(jsonMod.get(setting.getName()).getAsBoolean());
                    } else if (setting.getTypeOfSetting().equals("Mode")) {
                        setting.setModeValue(jsonMod.get(setting.getName()).getAsString());
                    } else if (setting.getTypeOfSetting().equals("Slider")) {
                        setting.setSliderValue(jsonMod.get(setting.getName()).getAsFloat());
                    } else if (setting.getTypeOfSetting().equals("Text Box")) {
                        setting.setTextBoxValue(jsonMod.get(setting.getName()).getAsString());
                    } else {
                        String[] colors = jsonMod.get(setting.getName()).getAsString().split(", ");
                        int[] intColors = new int[] { Integer.parseInt(colors[0]), Integer.parseInt(colors[1]),
                                Integer.parseInt(colors[2]) };
                        setting.setColors(intColors);
                    }
                }
            }
        }
        
        catch (Exception e)
        {   
        }
    }
}
